#!/bin/bash

print_help() {
  echo """
usage: $0 [-s] [-d]

Perform a safe reboot (or shutdown) of the Wild Sage Node by executing shutdown / reboot on all
agents (i.e. RPi) before executing power cycle on the NX core.

  -s : execute shutdown instead [defaul: reboot]
  -d : (optional) dry-run mode (don't perform shutdown/reboot) [default: False]
"""
}

AGENTS=(
  "ws-rpi"
  "ws-nxagent"
)

SHUTDOWN=
DRY=
nx_action="reboot"
nx_cmd="reboot"
while getopts "sd?" opt; do
  case $opt in
    s) SHUTDOWN=1
      nx_action="shutdown"
      nx_cmd="poweroff"
      ;;
    d) DRY=1
       echo "** DRY RUN MODE **"
      ;;
    ?|*)
      print_help
      exit 1
      ;;
  esac
done

echo "Executing system ${nx_action}"

# always shutdown the agents, on system power-up the agents will be restarted
for agent in "${AGENTS[@]}"; do
  echo "- shutdown $agent..."
  if [ -z "${DRY}" ]; then
    if ! ssh -q $agent 'systemctl poweroff'; then
      echo "WARNING: unable to shutdown agent [$agent]"
    fi
  fi
  echo "- shutdown $agent...DONE"
done

# always power off the PSU ports, on system power-up the PSU ports will be powered on
echo "- power off PSU ports..."
if [ -z "${DRY}" ]; then
  if ! waggle-set-psu-state off off; then
    echo "WARNING: unable turn off PSU outputs"
  fi
fi
echo "- power off PSU ports...DONE"

# reboot / shutdown the NX core
echo "- ${nx_action} nx core..."
if [ -z "${DRY}" ]; then
  if ! systemctl ${nx_cmd}; then
    echo "ERROR: unable ${nx_action} NX core"
  fi
fi
echo "- ${nx_action} nx core...DONE"
